<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>U.S. National Accounts: Flow of Funds</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Serif+4:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
  <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
</head>
<body>

  <header class="page-header">
    <h1>U.S. National Accounts: Flow of Funds</h1>
    <p class="subtitle">How money moves through the American economy &mdash; tracing the path from GDP through income, taxes, government spending, and household consumption.</p>
    <p class="byline">Data: Bureau of Economic Analysis, CBO, U.S. Treasury &middot; <time>2024</time></p>
  </header>

  <main>
    <section class="prose">
      <p>
        This diagram maps the flow of funds in the U.S. economy using the income-side
        decomposition of GDP. Starting from the $29.7 trillion GDP at the left, money flows
        into income categories (wages, profits, rents), through taxes to federal and state
        governments, back to households as transfers, and finally into consumer spending.
        Click any node to highlight its connections; hover for details.
      </p>
    </section>

    <div class="sankey-container" id="sankey-container">
      <div id="chart"></div>
      <div class="legend" id="legend"></div>
    </div>
  </main>

  <div class="tooltip" id="tooltip"></div>

  <footer>
    <p>
      Sources: Bureau of Economic Analysis (BEA) &mdash; GDP and National Income and Product Accounts;
      Congressional Budget Office (CBO) &mdash; Monthly Budget Review FY2024;
      U.S. Treasury &mdash; Fiscal Data;
      Bureau of Labor Statistics (BLS) &mdash; Consumer Expenditure Survey 2024.
      All figures in billions of current U.S. dollars. Some values are estimated from Q3/Q4 2024 annualized rates.
      Minor categories are aggregated for visual clarity; totals may not sum exactly due to rounding and statistical discrepancies.
    </p>
  </footer>

<script>
// ============================================================
// DATA (from researcher: data/national_accounts.json)
// ============================================================
const RAW_NODES = [
  { id: 0,  name: "Gross Domestic Product",         rawCategory: "gdp" },
  { id: 1,  name: "Compensation of Employees",      rawCategory: "income" },
  { id: 2,  name: "Corporate Profits",              rawCategory: "income" },
  { id: 3,  name: "Proprietors' Income",            rawCategory: "income" },
  { id: 4,  name: "Rental Income",                  rawCategory: "income" },
  { id: 5,  name: "Net Interest & Misc.",           rawCategory: "income" },
  { id: 6,  name: "Taxes on Production",            rawCategory: "income" },
  { id: 7,  name: "Depreciation (CCA)",             rawCategory: "income" },
  { id: 8,  name: "Personal Income Tax",            rawCategory: "tax" },
  { id: 9,  name: "Payroll Taxes",                  rawCategory: "tax" },
  { id: 10, name: "Corporate Income Tax",           rawCategory: "tax" },
  { id: 11, name: "Federal Government",             rawCategory: "government" },
  { id: 12, name: "State & Local Government",       rawCategory: "government" },
  { id: 13, name: "Social Security",                rawCategory: "federal_spending" },
  { id: 14, name: "Medicare",                       rawCategory: "federal_spending" },
  { id: 15, name: "Medicaid",                       rawCategory: "federal_spending" },
  { id: 16, name: "National Defense",               rawCategory: "federal_spending" },
  { id: 17, name: "Net Interest on Debt",           rawCategory: "federal_spending" },
  { id: 18, name: "Other Mandatory & Transfers",    rawCategory: "federal_spending" },
  { id: 36, name: "Nondefense Discretionary",       rawCategory: "federal_spending" },
  { id: 19, name: "Disposable Personal Income",     rawCategory: "household" },
  { id: 20, name: "Housing & Utilities",            rawCategory: "consumption" },
  { id: 21, name: "Healthcare",                     rawCategory: "consumption" },
  { id: 22, name: "Food & Beverages",               rawCategory: "consumption" },
  { id: 23, name: "Transportation",                 rawCategory: "consumption" },
  { id: 24, name: "Recreation & Entertainment",     rawCategory: "consumption" },
  { id: 25, name: "Financial Services & Insurance", rawCategory: "consumption" },
  { id: 26, name: "Other Goods & Services",         rawCategory: "consumption" },
  { id: 27, name: "Personal Savings",               rawCategory: "savings" },
  { id: 28, name: "Education",                      rawCategory: "state_local" },
  { id: 29, name: "Public Welfare & Health",        rawCategory: "state_local" },
  { id: 30, name: "Infrastructure & Other",         rawCategory: "state_local" },
  { id: 31, name: "Federal Borrowing (Deficit)",    rawCategory: "deficit" },
  { id: 32, name: "Retained Earnings",              rawCategory: "business" },
  { id: 33, name: "Dividends to Households",        rawCategory: "income_flow" },
  { id: 34, name: "Government Transfers",           rawCategory: "transfers" },
  { id: 35, name: "Other Federal Revenue",          rawCategory: "tax" }
];

const RAW_LINKS = [
  { source: 0,  target: 1,  value: 14900 },
  { source: 0,  target: 2,  value: 3600 },
  { source: 0,  target: 3,  value: 2050 },
  { source: 0,  target: 4,  value: 1100 },
  { source: 0,  target: 5,  value: 1250 },
  { source: 0,  target: 6,  value: 1800 },
  { source: 0,  target: 7,  value: 5000 },
  { source: 1,  target: 8,  value: 2430 },
  { source: 1,  target: 9,  value: 1710 },
  { source: 1,  target: 19, value: 10760 },
  { source: 2,  target: 10, value: 530 },
  { source: 2,  target: 33, value: 1500 },
  { source: 2,  target: 32, value: 1570 },
  { source: 3,  target: 19, value: 1750 },
  { source: 3,  target: 8,  value: 300 },
  { source: 4,  target: 19, value: 1100 },
  { source: 5,  target: 19, value: 1250 },
  { source: 33, target: 19, value: 1500 },
  { source: 8,  target: 11, value: 2730 },
  { source: 9,  target: 11, value: 1710 },
  { source: 10, target: 11, value: 530 },
  { source: 35, target: 11, value: 230 },
  { source: 31, target: 11, value: 1700 },
  { source: 6,  target: 12, value: 1800 },
  { source: 11, target: 13, value: 1461 },
  { source: 11, target: 14, value: 870 },
  { source: 11, target: 15, value: 620 },
  { source: 11, target: 16, value: 874 },
  { source: 11, target: 17, value: 882 },
  { source: 11, target: 18, value: 700 },
  { source: 11, target: 36, value: 1493 },
  { source: 13, target: 34, value: 1461 },
  { source: 14, target: 34, value: 870 },
  { source: 15, target: 34, value: 620 },
  { source: 18, target: 34, value: 700 },
  { source: 34, target: 19, value: 3651 },
  { source: 12, target: 28, value: 750 },
  { source: 12, target: 29, value: 540 },
  { source: 12, target: 30, value: 510 },
  { source: 19, target: 20, value: 4250 },
  { source: 19, target: 21, value: 2900 },
  { source: 19, target: 22, value: 2350 },
  { source: 19, target: 23, value: 1850 },
  { source: 19, target: 24, value: 1200 },
  { source: 19, target: 25, value: 1700 },
  { source: 19, target: 26, value: 2761 },
  { source: 19, target: 27, value: 3000 }
];

// ============================================================
// MAP RESEARCHER CATEGORIES -> DESIGNER COLOR CATEGORIES
// ============================================================
const CATEGORY_MAP = {
  gdp:                 "business",
  income:              "household",
  tax:                 "govt",
  government:          "govt",
  federal_spending:    "govt",
  household:           "household",
  consumption:         "household",
  savings:             "financial",
  state_local:         "govt",
  deficit:             "financial",
  business:            "business",
  income_flow:         "financial",
  transfers:           "govt"
};

const DATA = {
  nodes: RAW_NODES.map(n => ({
    id: n.id,
    name: n.name,
    category: CATEGORY_MAP[n.rawCategory] || "trade"
  })),
  links: RAW_LINKS.map(l => ({ ...l }))
};

// ============================================================
// CATEGORY COLORS (matching CSS custom properties)
// ============================================================
const CATEGORY_COLORS = {
  govt:      "#2171b5",
  household: "#238b45",
  business:  "#d94701",
  financial: "#6a51a3",
  trade:     "#636363"
};

const CATEGORY_LABELS = {
  govt:      "Government & GDP",
  household: "Households & Income",
  business:  "Business & Investment",
  financial: "Financial & Savings",
  trade:     "Rest of World"
};

// ============================================================
// FORMAT HELPERS
// ============================================================
function formatValue(v) {
  if (v >= 1000) {
    return "$" + d3.format(",.2f")(v / 1000) + "T";
  }
  return "$" + d3.format(",.0f")(v) + "B";
}

function formatValueBillions(v) {
  return "$" + d3.format(",.0f")(v) + "B";
}

// ============================================================
// CHART DIMENSIONS
// ============================================================
const chartEl = document.getElementById("chart");
const margin = { top: 24, right: 220, bottom: 24, left: 200 };

function getDimensions() {
  const w = Math.min(1200, chartEl.clientWidth || 1000);
  return {
    width: w - margin.left - margin.right,
    height: Math.max(700, Math.min(900, window.innerHeight * 0.7))
  };
}

const dims = getDimensions();

// ============================================================
// SVG
// ============================================================
const svgEl = d3.select("#chart")
  .append("svg")
    .attr("role", "img")
    .attr("aria-label", "Sankey diagram showing U.S. national accounts flow of funds, 2024")
    .attr("viewBox", `0 0 ${dims.width + margin.left + margin.right} ${dims.height + margin.top + margin.bottom}`)
    .attr("preserveAspectRatio", "xMidYMid meet");

const svg = svgEl.append("g")
  .attr("transform", `translate(${margin.left},${margin.top})`);

// ============================================================
// TOOLTIP FUNCTIONS
// ============================================================
const tooltip = d3.select("#tooltip");

function showTooltip(event) {
  tooltip.classed("is-visible", true);
  positionTooltip(event);
}

function positionTooltip(event) {
  const pad = 16;
  let x = event.pageX + pad;
  let y = event.pageY - pad;
  // Keep tooltip on screen
  const ttWidth = 280;
  if (x + ttWidth > window.innerWidth) {
    x = event.pageX - ttWidth - pad;
  }
  if (y < 0) y = pad;
  // Bottom-edge check
  const ttHeight = tooltip.node().getBoundingClientRect().height;
  if (y + ttHeight > window.innerHeight) {
    y = event.pageY - ttHeight - pad;
  }
  tooltip.style("left", x + "px").style("top", y + "px");
}

function hideTooltip() {
  tooltip.classed("is-visible", false);
}

const NODE_DESCRIPTIONS = {
  0:  "The total value of all goods and services produced in the U.S. in a year — the broadest measure of the economy's size.",
  1:  "Wages, salaries, and benefits paid to workers — the largest slice of national income.",
  2:  "What's left of business revenue after paying workers, suppliers, and other costs.",
  3:  "Income earned by self-employed people, freelancers, and small-business owners.",
  4:  "Income from owning property or land, including imputed rent for homeowners.",
  5:  "Interest earned by households and businesses on savings, bonds, and loans, minus interest paid.",
  6:  "Sales taxes, property taxes, customs duties, and other taxes baked into the price of goods.",
  7:  "The cost of wear and tear on buildings, equipment, and software — money set aside to replace aging capital.",
  8:  "Federal and state taxes on individual income from wages, investments, and other sources.",
  9:  "Social Security and Medicare taxes withheld from paychecks, split between workers and employers.",
  10: "Federal tax on corporate profits, after deductions and credits.",
  11: "Total federal revenue from taxes, borrowing, and other sources, funding all federal programs.",
  12: "Revenue from property taxes, sales taxes, and state income taxes, funding local services.",
  13: "Monthly payments to retirees and disabled workers, funded by payroll taxes.",
  14: "Federal health insurance for Americans 65 and older, covering hospital and doctor visits.",
  15: "Joint federal-state health insurance for low-income families, children, and the elderly.",
  16: "Spending on the military, including personnel, weapons systems, and operations.",
  17: "Interest the federal government pays on the national debt — a fast-growing budget item.",
  18: "Veterans' benefits, food assistance (SNAP), unemployment insurance, and other safety-net programs.",
  36: "Federal spending on science, transportation, education, housing, and other civilian agencies.",
  19: "The money households actually have to spend or save after taxes — their take-home income plus government benefits.",
  20: "Rent, mortgage payments, electricity, water, gas, and home maintenance.",
  21: "Out-of-pocket medical costs, insurance premiums, and other health-related spending by households.",
  22: "Groceries, restaurant meals, and beverages — both at home and eating out.",
  23: "Cars, gasoline, public transit, rideshares, and vehicle maintenance.",
  24: "Streaming services, sports, travel, hobbies, and other leisure spending.",
  25: "Banking fees, insurance premiums, brokerage services, and financial planning.",
  26: "Clothing, personal care, education, communication services, and everything else households buy.",
  27: "The portion of take-home pay that households don't spend — money flowing into bank accounts, retirement funds, and investments.",
  28: "State and local spending on public K-12 schools, community colleges, and state universities.",
  29: "State-funded Medicaid, welfare programs, public hospitals, and community health services.",
  30: "Roads, bridges, water systems, police, fire departments, parks, and general government operations.",
  31: "The gap between what the federal government spends and what it collects in taxes — covered by issuing Treasury bonds.",
  32: "The share of corporate profits that companies keep to reinvest in the business rather than pay out as dividends.",
  33: "Corporate profits paid out to shareholders — a key source of household investment income.",
  34: "Social Security checks, Medicare benefits, Medicaid, and other government payments that flow to households.",
  35: "Estate taxes, excise taxes, Federal Reserve earnings, and other miscellaneous federal income."
};

function setNodeTooltip(d) {
  const color = CATEGORY_COLORS[d.category];
  let html = `<div class="tooltip-title"><span class="tooltip-swatch" style="background:${color}"></span>${d.name}</div>`;
  html += `<div class="tooltip-value">${formatValue(d.value)}</div>`;
  const desc = NODE_DESCRIPTIONS[d.id];
  if (desc) {
    html += `<div class="tooltip-detail" style="margin-bottom:6px;color:var(--color-text-secondary)">${desc}</div>`;
  }

  if (d.targetLinks.length > 0) {
    html += `<div class="tooltip-detail"><strong>Inflows:</strong></div>`;
    d.targetLinks
      .sort((a, b) => b.value - a.value)
      .forEach(l => {
        html += `<div class="tooltip-flow-label"><span class="arrow">&larr;</span> ${l.source.name}: ${formatValueBillions(l.value)}</div>`;
      });
  }
  if (d.sourceLinks.length > 0) {
    html += `<div class="tooltip-detail" style="margin-top:4px"><strong>Outflows:</strong></div>`;
    d.sourceLinks
      .sort((a, b) => b.value - a.value)
      .forEach(l => {
        html += `<div class="tooltip-flow-label"><span class="arrow">&rarr;</span> ${l.target.name}: ${formatValueBillions(l.value)}</div>`;
      });
  }
  tooltip.html(html);
}

function setLinkTooltip(d) {
  const color = CATEGORY_COLORS[d.source.category];
  const html = `<div class="tooltip-title"><span class="tooltip-swatch" style="background:${color}"></span>${d.source.name} <span class="arrow">&rarr;</span> ${d.target.name}</div>` +
    `<div class="tooltip-value">${formatValueBillions(d.value)}</div>`;
  tooltip.html(html);
}

// ============================================================
// SANKEY LAYOUT
// ============================================================
const sankey = d3.sankey()
  .nodeId(d => d.id)
  .nodeWidth(18)
  .nodePadding(10)
  .nodeAlign(d3.sankeyLeft)
  .iterations(32)
  .extent([[0, 0], [dims.width, dims.height]]);

const graph = sankey({
  nodes: DATA.nodes.map(d => ({ ...d })),
  links: DATA.links.map(d => ({ ...d }))
});

// ============================================================
// RENDER LINKS
// ============================================================
const linkGroup = svg.append("g").attr("class", "sankey-links");

const links = linkGroup.selectAll(".sankey-link")
  .data(graph.links)
  .join("path")
    .attr("class", d => `sankey-link link-${d.source.category}`)
    .attr("d", d3.sankeyLinkHorizontal())
    .attr("stroke-width", d => Math.max(1, d.width))
    .on("mouseover", function(event, d) {
      setLinkTooltip(d);
      showTooltip(event);
      if (!selectedNode) {
        d3.select(this).classed("is-highlighted", true);
      }
    })
    .on("mousemove", function(event) {
      positionTooltip(event);
    })
    .on("mouseout", function() {
      hideTooltip();
      if (!selectedNode) {
        d3.select(this).classed("is-highlighted", false);
      }
    });

// ============================================================
// RENDER NODES
// ============================================================
const nodeGroup = svg.append("g").attr("class", "sankey-nodes");

const nodes = nodeGroup.selectAll(".sankey-node")
  .data(graph.nodes)
  .join("g")
    .attr("class", d => `sankey-node node-${d.category}`)
    .attr("transform", d => `translate(${d.x0},${d.y0})`);

nodes.append("rect")
  .attr("height", d => Math.max(1, d.y1 - d.y0))
  .attr("width", sankey.nodeWidth())
  .attr("rx", 2)
  .attr("ry", 2);

// Label side: source-only nodes get left labels, everything else right
function labelOnLeft(d) {
  return d.targetLinks.length === 0; // source nodes only
}

// Node name labels
nodes.append("text")
  .attr("x", d => labelOnLeft(d) ? -6 : sankey.nodeWidth() + 6)
  .attr("y", d => (d.y1 - d.y0) / 2)
  .attr("dy", "0.35em")
  .attr("text-anchor", d => labelOnLeft(d) ? "end" : "start")
  .attr("class", "node-name")
  .text(d => d.name);

// Node value labels below names (only for nodes tall enough)
nodes.filter(d => (d.y1 - d.y0) > 16)
  .append("text")
  .attr("x", d => labelOnLeft(d) ? -6 : sankey.nodeWidth() + 6)
  .attr("y", d => (d.y1 - d.y0) / 2 + 13)
  .attr("dy", "0.35em")
  .attr("text-anchor", d => labelOnLeft(d) ? "end" : "start")
  .attr("class", "node-value")
  .style("font-size", "9.5px")
  .style("fill", d => CATEGORY_COLORS[d.category])
  .style("font-weight", "600")
  .style("opacity", 0.8)
  .text(d => formatValue(d.value));

// ============================================================
// NODE HOVER
// ============================================================
nodes
  .on("mouseover", function(event, d) {
    setNodeTooltip(d);
    showTooltip(event);
    if (!selectedNode) {
      temporaryHighlight(d);
    }
  })
  .on("mousemove", function(event) {
    positionTooltip(event);
  })
  .on("mouseout", function() {
    hideTooltip();
    if (!selectedNode) {
      clearHighlight();
    }
  });

// ============================================================
// CLICK-TO-HIGHLIGHT
// ============================================================
let selectedNode = null;
let treeViewActive = false;
let treeTransitioning = false;
const container = d3.select("#sankey-container");

nodes.on("click", function(event, d) {
  event.stopPropagation();

  // Block all clicks during transitions
  if (treeTransitioning) return;

  // If depreciation node is clicked, enter tree drill-down
  if (d.id === 7 && !treeViewActive) {
    enterTreeView();
    return;
  }

  if (treeViewActive) return;

  if (selectedNode === d) {
    selectedNode = null;
    clearHighlight();
    return;
  }

  selectedNode = d;
  applyHighlight(d);
});

d3.select("body").on("click", function() {
  if (treeViewActive && !treeTransitioning) {
    exitTreeView();
    return;
  }
  if (selectedNode) {
    selectedNode = null;
    clearHighlight();
    document.querySelectorAll(".legend-item").forEach(el => el.classList.remove("is-active"));
  }
});

function temporaryHighlight(d) {
  container.classed("has-focus", true);
  markConnected(d);
}

function applyHighlight(d) {
  container.classed("has-focus", true);
  markConnected(d);
}

function markConnected(d) {
  const connectedNodeIds = new Set();
  connectedNodeIds.add(d.index);
  d.sourceLinks.forEach(l => connectedNodeIds.add(l.target.index));
  d.targetLinks.forEach(l => connectedNodeIds.add(l.source.index));

  links.classed("is-highlighted", l => l.source === d || l.target === d);
  nodes.classed("is-highlighted", n => connectedNodeIds.has(n.index));
}

function clearHighlight() {
  container.classed("has-focus", false);
  links.classed("is-highlighted", false);
  nodes.classed("is-highlighted", false);
}

// ============================================================
// LEGEND
// ============================================================
function buildLegend() {
  const legendEl = document.getElementById("legend");
  const categories = ["govt", "household", "business", "financial", "trade"];

  categories.forEach(cat => {
    if (!DATA.nodes.some(n => n.category === cat)) return;

    const item = document.createElement("div");
    item.className = "legend-item";
    item.dataset.category = cat;

    const swatch = document.createElement("span");
    swatch.className = `legend-swatch swatch-${cat}`;

    item.appendChild(swatch);
    item.appendChild(document.createTextNode(CATEGORY_LABELS[cat]));
    legendEl.appendChild(item);

    item.addEventListener("click", () => {
      if (treeViewActive) return;
      const alreadyActive = item.classList.contains("is-active");
      document.querySelectorAll(".legend-item").forEach(el => el.classList.remove("is-active"));
      selectedNode = null;

      if (alreadyActive) {
        clearHighlight();
        return;
      }

      item.classList.add("is-active");
      container.classed("has-focus", true);

      const catNodes = new Set();
      graph.nodes.forEach(n => { if (n.category === cat) catNodes.add(n.index); });

      links.classed("is-highlighted", l => catNodes.has(l.source.index) || catNodes.has(l.target.index));
      nodes.classed("is-highlighted", n => {
        if (catNodes.has(n.index)) return true;
        return n.sourceLinks.some(l => catNodes.has(l.target.index)) ||
               n.targetLinks.some(l => catNodes.has(l.source.index));
      });
    });
  });
}

buildLegend();

// ============================================================
// ACCESSIBLE SUMMARY (hidden for screen readers)
// ============================================================
const summary = document.createElement("p");
summary.className = "visually-hidden";
summary.textContent = `Sankey diagram showing the flow of ${formatValue(graph.nodes[0].value)} in US GDP (2024) through ${graph.nodes.length} economic sectors including personal consumption, government spending, investment, and household expenses.`;
document.querySelector(".sankey-container").prepend(summary);

// ============================================================
// RESPONSIVE
// ============================================================
window.addEventListener("resize", () => {
  const d = getDimensions();
  svgEl.attr("viewBox", `0 0 ${d.width + margin.left + margin.right} ${d.height + margin.top + margin.bottom}`);
});

// ============================================================
// DEPRECIATION TREE DRILL-DOWN
// ============================================================

// Depreciation breakdown data (BEA Fixed Assets, 2024 estimates — 5 levels)
const DEPRECIATION_TREE = {"name":"Depreciation (CCA)","value":5000,"children":[{"name":"Private","value":4300,"children":[{"name":"Nonresidential","value":3050,"children":[{"name":"Structures","value":650,"children":[{"name":"Commercial & Health Care","value":185,"children":[{"name":"Offices","value":55},{"name":"Hospitals & Medical","value":40},{"name":"Retail & Wholesale","value":35},{"name":"Warehouses","value":30},{"name":"Hotels & Lodging","value":25}]},{"name":"Power & Communication","value":155,"children":[{"name":"Electric Power","value":65},{"name":"Telecommunication","value":45},{"name":"Wind & Solar","value":25},{"name":"Gas Pipelines & Storage","value":20}]},{"name":"Mining & Petroleum","value":130,"children":[{"name":"Petroleum Wells","value":75},{"name":"Mining Shafts & Wells","value":30},{"name":"Gas Wells","value":25}]},{"name":"Manufacturing","value":80,"children":[{"name":"Chemical & Pharma Plants","value":25},{"name":"Food & Beverage Plants","value":15},{"name":"Semiconductor Fabs","value":15},{"name":"Auto & Machinery Plants","value":15},{"name":"Other Manufacturing","value":10}]},{"name":"Other Structures","value":100,"children":[{"name":"Educational & Religious","value":30},{"name":"Amusement & Recreation","value":25},{"name":"Transportation Facilities","value":25},{"name":"Farm Structures","value":20}]}]},{"name":"Equipment","value":1100,"children":[{"name":"Information Processing","value":450,"children":[{"name":"Computers & Peripherals","value":120},{"name":"Communication Equipment","value":105},{"name":"Software in Equipment","value":80},{"name":"Medical Instruments","value":55},{"name":"Electromedical Equipment","value":45},{"name":"Office Equipment","value":45}]},{"name":"Industrial Equipment","value":235,"children":[{"name":"Metalworking Machinery","value":45},{"name":"Special Industry Machinery","value":40},{"name":"General Industrial","value":40},{"name":"Construction Machinery","value":35},{"name":"Mining & Oilfield Machinery","value":35},{"name":"Service Industry Machinery","value":25},{"name":"Electrical Transmission","value":15}]},{"name":"Transportation Equipment","value":260,"children":[{"name":"Trucks & Light Vehicles","value":95},{"name":"Aircraft","value":60},{"name":"Heavy Trucks & Buses","value":40},{"name":"Railroad Equipment","value":25},{"name":"Ships & Boats","value":20},{"name":"Autos","value":20}]},{"name":"Other Equipment","value":155,"children":[{"name":"Furniture & Fixtures","value":40},{"name":"Agricultural Machinery","value":35},{"name":"Electrical Equipment","value":30},{"name":"Engines & Turbines","value":25},{"name":"Household Equipment","value":25}]}]},{"name":"Intellectual Property","value":1300,"children":[{"name":"Software","value":585,"children":[{"name":"Custom Software","value":235},{"name":"Prepackaged Software","value":210},{"name":"Own-Account Software","value":140}]},{"name":"Research & Development","value":630,"children":[{"name":"Pharma & Medicine","value":145},{"name":"Semiconductor & Electronics","value":85},{"name":"Software R&D","value":80},{"name":"Aerospace & Defense","value":65},{"name":"Chemical Manufacturing","value":50},{"name":"Automotive & Transport","value":45},{"name":"Other Manufacturing R&D","value":60},{"name":"Nonmanufacturing R&D","value":100}]},{"name":"Entertainment Originals","value":85,"children":[{"name":"Television Programs","value":30},{"name":"Theatrical Movies","value":25},{"name":"Books & Music","value":15},{"name":"Other Originals","value":15}]}]}]},{"name":"Residential","value":750,"children":[{"name":"Structures","value":730,"children":[{"name":"Single-Family","value":420,"children":[{"name":"Owner-Occupied","value":310},{"name":"Tenant-Occupied","value":110}]},{"name":"Multi-Family","value":210,"children":[{"name":"2-4 Unit Buildings","value":60},{"name":"5+ Unit Buildings","value":150}]},{"name":"Other Residential","value":100,"children":[{"name":"Manufactured Homes","value":40},{"name":"Improvements & Commissions","value":45},{"name":"Dormitories & Other","value":15}]}]},{"name":"Equipment & Other","value":20,"children":[{"name":"Residential Equipment","value":12},{"name":"Residential IP Products","value":8}]}]},{"name":"Nonprofit Institutions","value":500,"children":[{"name":"Structures","value":180,"children":[{"name":"Educational Buildings","value":65},{"name":"Hospitals & Health Care","value":55},{"name":"Religious Buildings","value":30},{"name":"Other Nonprofit","value":30}]},{"name":"Equipment","value":120,"children":[{"name":"Medical & Scientific","value":45},{"name":"Information Processing","value":35},{"name":"Transportation","value":20},{"name":"Other Equipment","value":20}]},{"name":"Intellectual Property","value":200,"children":[{"name":"R&D","value":110},{"name":"Software","value":75},{"name":"Entertainment & Artistic","value":15}]}]}]},{"name":"Government","value":700,"children":[{"name":"Federal","value":300,"children":[{"name":"Defense","value":195,"children":[{"name":"Defense Equipment","value":120,"children":[{"name":"Aircraft & Missiles","value":45},{"name":"Ships & Submarines","value":25},{"name":"Vehicles & Tanks","value":20},{"name":"Electronics & Comms","value":15},{"name":"Weapons & Ordnance","value":15}]},{"name":"Defense IP","value":45,"children":[{"name":"Weapons R&D","value":25},{"name":"Defense Software","value":15},{"name":"Other Defense IP","value":5}]},{"name":"Defense Structures","value":30,"children":[{"name":"Military Bases","value":18},{"name":"Shipyards & Airfields","value":12}]}]},{"name":"Nondefense","value":105,"children":[{"name":"Nondefense IP","value":50,"children":[{"name":"Federal R&D (NASA, NIH, DOE)","value":35},{"name":"Government Software","value":12},{"name":"Other Nondefense IP","value":3}]},{"name":"Nondefense Structures","value":30,"children":[{"name":"Federal Office Buildings","value":12},{"name":"Conservation & Development","value":10},{"name":"Other Federal Structures","value":8}]},{"name":"Nondefense Equipment","value":25,"children":[{"name":"Vehicles & Transportation","value":8},{"name":"Information Processing","value":7},{"name":"Scientific Instruments","value":5},{"name":"Other Equipment","value":5}]}]}]},{"name":"State & Local","value":400,"children":[{"name":"Structures","value":240,"children":[{"name":"Highways & Streets","value":95,"children":[{"name":"Other Highways & Roads","value":40},{"name":"Interstate Highways","value":30},{"name":"Bridges & Tunnels","value":25}]},{"name":"Educational Buildings","value":55,"children":[{"name":"Primary & Secondary Schools","value":35},{"name":"Higher Education","value":20}]},{"name":"Water & Sewer Systems","value":45,"children":[{"name":"Water Supply","value":25},{"name":"Sewage & Waste Disposal","value":20}]},{"name":"Other S&L Structures","value":45,"children":[{"name":"Public Safety Buildings","value":15},{"name":"Hospitals & Health","value":12},{"name":"Transit & Transportation","value":10},{"name":"Parks & Recreation","value":8}]}]},{"name":"Equipment","value":95,"children":[{"name":"Transit Vehicles & Buses","value":25},{"name":"Information Processing","value":20},{"name":"Construction & Maintenance","value":15},{"name":"Public Safety Vehicles","value":15},{"name":"Other S&L Equipment","value":20}]},{"name":"Intellectual Property","value":65,"children":[{"name":"Software","value":40},{"name":"R&D (Universities & Labs)","value":20},{"name":"Other IP","value":5}]}]}]}]};

// Color scale for tree depth levels
const TREE_COLORS = [
  "#d94701",  // root: business orange
  "#e6550d",  // level 1
  "#fd8d3c",  // level 2
  "#fdae6b",  // level 3 (leaves)
];

let treeGroup = null;

// Add back button to container
const backBtn = document.createElement("button");
backBtn.className = "tree-back-btn";
backBtn.setAttribute("aria-label", "Back to Sankey overview");
backBtn.innerHTML = '<span class="arrow" aria-hidden="true">&larr;</span> Back to overview';
document.querySelector(".sankey-container").appendChild(backBtn);

backBtn.addEventListener("click", function(event) {
  event.stopPropagation();
  exitTreeView();
});

// Add "click to explore" hint on the depreciation node
const depNodeG = nodes.filter(n => n.id === 7);
depNodeG.select("rect")
  .attr("tabindex", 0)
  .attr("role", "button")
  .attr("aria-label", "Depreciation (CCA) — click to explore breakdown");
depNodeG.append("text")
  .attr("class", "depreciation-hint")
  .attr("x", d => labelOnLeft(d) ? -6 : sankey.nodeWidth() + 6)
  .attr("y", d => (d.y1 - d.y0) / 2 + 26)
  .attr("dy", "0.35em")
  .attr("text-anchor", d => labelOnLeft(d) ? "end" : "start")
  .text("Click to explore \u25B6");

// Escape key exits tree view
document.addEventListener("keydown", function(event) {
  if (event.key === "Escape" && treeViewActive && !treeTransitioning) {
    exitTreeView();
  }
});

// Respect reduced-motion preference for D3 transitions
const reducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
const DUR_FADE_OUT = reducedMotion ? 0 : 400;
const DUR_FADE_IN  = reducedMotion ? 0 : 500;
const DUR_TREE_OUT = reducedMotion ? 0 : 300;

// Helper: count-based transition completion that handles interrupts
function onAllDone(selection, callback) {
  let count = 0;
  const total = selection.size();
  if (total === 0) { callback(); return; }
  function tick() {
    count++;
    if (count === total) callback();
  }
  selection.on("end.done", tick).on("interrupt.done", tick);
}

function enterTreeView() {
  if (treeTransitioning) return;
  treeViewActive = true;
  treeTransitioning = true;
  selectedNode = null;
  clearHighlight();
  hideTooltip();
  document.querySelectorAll(".legend-item").forEach(el => el.classList.remove("is-active"));

  // Interrupt any in-flight transitions
  svg.selectAll(".sankey-links, .sankey-nodes").interrupt();
  if (treeGroup) {
    treeGroup.interrupt();
    treeGroup.remove();
    treeGroup = null;
  }

  // Fade out Sankey elements, then render treemap
  const sankeyEls = svg.selectAll(".sankey-links, .sankey-nodes");

  const t = sankeyEls
    .transition()
    .duration(DUR_FADE_OUT)
    .style("opacity", 0);

  onAllDone(t, function() {
    sankeyEls.style("display", "none");
    renderTree();
    treeTransitioning = false;
  });

  // Show back button and focus it for keyboard users
  backBtn.classList.add("is-visible");
  requestAnimationFrame(() => backBtn.focus());
}

function exitTreeView() {
  if (!treeViewActive || treeTransitioning) return;
  treeViewActive = false;
  treeTransitioning = true;
  hideTooltip();

  // Hide back button
  backBtn.classList.remove("is-visible");

  // Interrupt any in-flight transitions on Sankey elements
  svg.selectAll(".sankey-links, .sankey-nodes").interrupt();

  // Fade out and remove tree
  if (treeGroup) {
    treeGroup.interrupt();
    treeGroup
      .transition()
      .duration(DUR_TREE_OUT)
      .style("opacity", 0)
      .on("end", function() { d3.select(this).remove(); })
      .on("interrupt", function() { d3.select(this).remove(); });
    treeGroup = null;
  }

  // Clear any stale highlight state
  clearHighlight();
  document.querySelectorAll(".legend-item").forEach(el => el.classList.remove("is-active"));

  // Fade Sankey back in
  const restoreEls = svg.selectAll(".sankey-links, .sankey-nodes");
  restoreEls
    .style("display", null)
    .style("opacity", 0);

  const t = restoreEls
    .transition()
    .duration(DUR_FADE_OUT)
    .style("opacity", 1);

  onAllDone(t, function() {
    treeTransitioning = false;
    // Return focus to depreciation node for keyboard users
    const depRect = depNodeG.select("rect").node();
    if (depRect) depRect.focus();
  });
}

// Abbreviation map for small treemap cells
const ABBREV = {
  "Structures": "Struc.", "Equipment": "Equip.", "Intellectual Property": "IP",
  "Nonresidential": "Non-Res.", "Information Processing": "Info Proc.",
  "Transportation Equipment": "Transport", "Industrial Equipment": "Industrial",
  "Entertainment Originals": "Entertain.", "Research & Development": "R&D",
  "Commercial & Health Care": "Comm/Health", "Power & Communication": "Power/Comm",
  "Mining & Petroleum": "Mining/Petro", "Manufacturing": "Mfg.",
  "Equipment & Other": "Equip.", "Nonprofit Institutions": "Nonprofit",
  "Improvements & Commissions": "Improve.", "Dormitories & Other": "Dorms etc.",
  "Construction & Maintenance": "Const/Maint"
};

function renderTree() {
  const tmWidth = dims.width;
  const tmHeight = dims.height - 30;
  const titleOffset = 30;

  // Build hierarchy
  const root = d3.hierarchy(DEPRECIATION_TREE)
    .sum(d => d.children ? 0 : d.value)
    .sort((a, b) => b.value - a.value);

  // Treemap layout with depth-adaptive padding
  d3.treemap()
    .size([tmWidth, tmHeight])
    .paddingTop(d => {
      if (d.depth === 0) return 0;
      if (d.depth === 1) return 18;
      if (d.depth === 2) return 15;
      if (d.depth === 3) return 12;
      return 0;
    })
    .paddingInner(2)
    .paddingOuter(1)
    .round(true)
    (root);

  // HSL depth-based color: Private=orange family, Government=blue family
  function cellColor(d) {
    let ancestor = d;
    while (ancestor.depth > 1) ancestor = ancestor.parent;
    const isPrivate = ancestor.data.name === "Private";
    const hueBase = isPrivate ? 25 : 210;
    const hueRange = isPrivate ? 25 : 30;

    const depth = Math.min(d.depth, 5);
    const sat = 80 - (depth - 1) * 10;
    const lit = 38 + (depth - 1) * 9;

    const siblings = d.parent ? d.parent.children : [d];
    const idx = siblings.indexOf(d);
    const hueShift = siblings.length > 1
      ? (idx / (siblings.length - 1) - 0.5) * hueRange
      : 0;

    return `hsl(${hueBase + hueShift}, ${sat}%, ${lit}%)`;
  }

  function useDarkText(d) {
    const depth = Math.min(d.depth, 5);
    const lit = 38 + (depth - 1) * 9;
    return lit > 58;
  }

  // Create group for treemap
  treeGroup = svg.append("g")
    .attr("class", "tree-view")
    .attr("role", "img")
    .attr("aria-label", "Treemap showing breakdown of $5 trillion in US depreciation by sector and asset type, 2024")
    .style("opacity", 0);

  // Title
  treeGroup.append("text")
    .attr("class", "treemap-title")
    .attr("x", 0)
    .attr("y", -6)
    .text("Depreciation (CCA): Where $5 Trillion in Capital Wears Out");

  treeGroup.append("text")
    .attr("class", "treemap-subtitle")
    .attr("x", 0)
    .attr("y", 12)
    .text("Consumption of fixed capital by sector and asset type, 2024 (billions USD)");

  const tmContent = treeGroup.append("g")
    .attr("transform", `translate(0, ${titleOffset})`);

  // Draw group labels (depth 1-3, non-leaf nodes)
  const groups = root.descendants().filter(d => d.depth > 0 && d.depth <= 3 && d.children);
  tmContent.selectAll(".treemap-group-label")
    .data(groups)
    .join("text")
      .attr("class", d => `treemap-group-label treemap-group-label--d${d.depth}`)
      .attr("x", d => d.x0 + 4)
      .attr("y", d => d.y0 + (d.depth === 1 ? 13 : d.depth === 2 ? 12 : 10))
      .text(d => {
        const cellWidth = d.x1 - d.x0;
        if (cellWidth < 60) return "";
        const label = `${d.data.name} ${formatValue(d.value)}`;
        if (label.length * 6 > cellWidth - 8) return d.data.name;
        return label;
      });

  // Draw leaf cells
  const leaves = root.leaves();

  const cells = tmContent.selectAll(".treemap-cell")
    .data(leaves)
    .join("g")
      .attr("class", "treemap-cell")
      .attr("transform", d => `translate(${d.x0},${d.y0})`);

  cells.append("rect")
    .attr("width", d => Math.max(0, d.x1 - d.x0))
    .attr("height", d => Math.max(0, d.y1 - d.y0))
    .attr("rx", 2)
    .attr("ry", 2)
    .attr("fill", d => cellColor(d));

  // Tiered label strategy based on cell dimensions
  cells.each(function(d) {
    const w = d.x1 - d.x0;
    const h = d.y1 - d.y0;
    const g = d3.select(this);
    const dark = useDarkText(d);
    const labelFill = dark ? "var(--color-text-primary)" : "#fff";
    const valueFill = dark ? "var(--color-text-secondary)" : "rgba(255,255,255,0.85)";
    const pctFill   = dark ? "var(--color-text-tertiary)" : "rgba(255,255,255,0.7)";

    // Tier 4: too small for anything
    if (w < 25 || h < 14) return;

    // Tier 3: abbreviation only (tiny cells)
    if (w < 40 || h < 22) {
      const abbr = ABBREV[d.data.name] || d.data.name.slice(0, Math.floor((w - 6) / 5.5));
      g.append("text")
        .attr("class", "treemap-cell-label treemap-cell-label--xs")
        .attr("x", 3).attr("y", h / 2 + 3)
        .attr("fill", labelFill)
        .text(abbr);
      return;
    }

    // Tier 2: name only, possibly truncated
    if (w < 60 || h < 36) {
      const maxChars = Math.floor((w - 8) / 5.5);
      const name = d.data.name;
      const display = name.length > maxChars ? (ABBREV[name] || name.slice(0, maxChars - 1) + "\u2026") : name;
      g.append("text")
        .attr("class", "treemap-cell-label treemap-cell-label--sm")
        .attr("x", 4).attr("y", 13)
        .attr("fill", labelFill)
        .text(display);
      return;
    }

    // Tier 1: full labels
    const maxChars = Math.floor((w - 10) / 6.5);
    const name = d.data.name;
    g.append("text")
      .attr("class", "treemap-cell-label")
      .attr("x", 5).attr("y", 14)
      .attr("fill", labelFill)
      .text(name.length > maxChars ? name.slice(0, maxChars - 1) + "\u2026" : name);

    if (h >= 34) {
      g.append("text")
        .attr("class", "treemap-cell-value")
        .attr("x", 5).attr("y", 27)
        .attr("fill", valueFill)
        .text(formatValue(d.value));
    }

    if (h >= 48 && w >= 80) {
      const pct = (d.value / root.value * 100).toFixed(1);
      g.append("text")
        .attr("class", "treemap-cell-pct")
        .attr("x", 5).attr("y", 39)
        .attr("fill", pctFill)
        .text(`${pct}% of total`);
    }
  });

  // Prevent cell clicks from bubbling to body (which would exit tree view)
  cells.on("click", function(event) {
    event.stopPropagation();
  });

  // Hover: highlight sibling group + tooltip with breadcrumb path
  cells
    .on("mouseover", function(event, d) {
      // Dim all cells, highlight siblings
      cells.select("rect").style("opacity", 0.6);
      const siblingLeaves = d.parent ? d.parent.leaves() : [d];
      cells.filter(c => siblingLeaves.includes(c))
        .select("rect").style("opacity", 1).style("filter", "brightness(1.08)");
      d3.select(this).select("rect")
        .style("opacity", 1).style("filter", "brightness(1.15)")
        .style("stroke", "#fff").style("stroke-width", "2px");

      // Tooltip with breadcrumb path
      const ancestors = d.ancestors().reverse().slice(1).map(a => a.data.name);
      let path = ancestors.join(" \u203A ");
      if (path.length > 45 && ancestors.length > 3) {
        path = `${ancestors[0]} \u203A \u2026 \u203A ${ancestors.slice(-2).join(" \u203A ")}`;
      }
      const pct = (d.value / root.value * 100).toFixed(1);
      const html = `<div class="tooltip-title"><span class="tooltip-swatch" style="background:${cellColor(d)}"></span>${d.data.name}</div>` +
        `<div class="tooltip-value">${formatValue(d.value)}</div>` +
        `<div class="tooltip-detail">${pct}% of total depreciation</div>` +
        `<div class="tooltip-detail" style="margin-top:4px;color:var(--color-text-tertiary)">${path}</div>`;
      tooltip.html(html);
      showTooltip(event);
    })
    .on("mousemove", function(event) {
      positionTooltip(event);
    })
    .on("mouseout", function() {
      // Reset all cells
      cells.select("rect")
        .style("opacity", null).style("filter", null)
        .style("stroke", null).style("stroke-width", null);
      hideTooltip();
    });

  // Fade in
  treeGroup
    .transition()
    .duration(DUR_FADE_IN)
    .style("opacity", 1);
}
</script>
</body>
</html>
